# AWS RAG Chatbot

## Table of Contents

1. [AWS Prerequisites](#aws-prerequisites)
2. [Quick Setup Steps](#quick-setup-steps)
3. [Troubleshooting](#troubleshooting)

---

## AWS Prerequisites

### 1. AWS Account Setup

#### Required AWS Services Access

- Amazon Bedrock
- Amazon S3
- Amazon OpenSearch Serverless
- AWS Lambda
- Amazon API Gateway
- AWS CloudWatch Logs

#### AWS CLI Configuration

```bash
aws configure
# Enter your AWS Access Key ID, Secret Access Key, Region, and output format
```

#### AWS CDK Bootstrap

```bash
npm install -g aws-cdk
cdk bootstrap aws://YOUR-ACCOUNT-ID/YOUR-REGION # in backend directory with cdk.json
```

### 2. Amazon Bedrock Model Access

#### Enable Foundation Models

1. Go to Amazon Bedrock console
2. Navigate to "Model access" in the left sidebar
3. Request access to these models:
   - **Cohere Embed Multilingual v3** (required for embeddings)
   - **Anthropic Claude Instant** (default chat model)
   - This project is using the 2 models above, make changes inside your code with your desired models.

#### Supported Regions

Regions that supports Amazon Bedrock:

- us-east-1 (N. Virginia)
- us-west-2 (Oregon)
- eu-west-1 (Ireland)
- ap-southeast-1 (Singapore)
- ap-northeast-1 (Tokyo)

### 3. Environment Variables

#### Required

Set these in `backend/.env` before deployment:

- `MODEL_ID`: Bedrock model for responses
- `ALLOWED_IP`: Your IP address for API access (or `0.0.0.0/0` for public)

#### Auto-Generated by CDK

These are automatically set during deployment:

- `KNOWLEDGE_BASE_ID`: Created knowledge base ID
- `DATA_SOURCE_ID`: Created S3 data source ID
- `AWS_REGION`: Lambda runtime region
- `BUCKET_ARN`: Created S3 bucket ARN

### 5. No Manual AWS Resource Creation Required

The CDK deployment will automatically create:

- Knowledge Base for Amazon Bedrock
- S3 bucket for documents
- OpenSearch Serverless collection
- Lambda functions
- All IAM roles and policies

---

## Quick Setup Steps

### Prerequisites

1. **AWS CLI**: Install and configure with your credentials
2. **AWS CDK**: Install globally with `npm install -g aws-cdk`
3. **CDK Bootstrap**: Run `cdk bootstrap aws://ACCOUNT-ID/REGION`
4. **Bedrock Access**: Access to models in Amazon Bedrock console

### Backend Setup

1. Navigate to the backend folder:

   ```bash
   cd backend
   ```

2. Install dependencies:

   ```bash
   npm install
   ```

3. Create environment file:

   ```bash
   cp .env.example .env
   ```

4. Configure `backend/.env`:

   ```bash

   # Edit .env file with your IP and preferred model
   MODEL_ID=anthropic.claude-instant-v1
   ALLOWED_IP=0.0.0.0/0
   ```

   **Note**: Only set these 2 variables. CDK automatically sets:

   - `KNOWLEDGE_BASE_ID`, `DATA_SOURCE_ID`, `AWS_REGION`, `BUCKET_ARN`

5. Deploy to AWS:

   ```bash
   # On Windows
   deploy.bat

   # On Unix/Linux/macOS
   chmod +x deploy.sh
   ./deploy.sh
   ```

6. **Important**: Note these outputs from deployment:
   - `BackendStack.APIGatewayUrl` (for frontend)
   - `BackendStack.DocsBucketName` (for uploading documents)

### Frontend Setup

1. Navigate to the frontend folder:

   ```bash
   cd frontend
   ```

2. Install dependencies:

   ```bash
   npm install
   ```

3. Create environment file:

   ```bash
   cp .env.example .env
   ```

4. Configure `frontend/.env` with the API Gateway URL (`BackendStack.APIGatewayUrl`) from backend deployment:

   ```
   REACT_APP_API_BASE_URL=https://abc123def4.execute-api.us-east-1.amazonaws.com/prod/
   ```

5. Start the application:
   ```bash
   npm start
   ```

### Usage

1. **Upload Documents**: Add PDF/text files to the S3 bucket from deployment output (`BackendStack.DocsBucketName`)
2. **Wait for Processing**: Documents are automatically ingested (check CloudWatch logs to see if ingest lambda is triggered)
3. **Ask Questions**: Use the web interface to query your documents

### Model switching

Update `MODEL_ID` in `backend/.env` (requires redeployment):

Example models:

- `anthropic.claude-instant-v1`
- `anthropic.claude-v2`
- `anthropic.claude-3-haiku-20240307-v1:0`
- `anthropic.claude-3-sonnet-20240229-v1:0`
- `amazon.titan-text-premier-v1:0`

---

## Troubleshooting

### Common Issues

#### Bootstrap Errors

```bash
# Bootstrap again
aws cloudformation delete-stack --stack-name CDKToolkit
cdk bootstrap
```

#### 403 Errors

- Check your IP in `ALLOWED_IP` matches your current public IP
- For public access, use `ALLOWED_IP=0.0.0.0/0`

#### Model Access Errors

- Ensure you have access to the selected model in Bedrock console
- Check both chat model and embedding model access

#### No Answers from Chatbot

- Verify documents are uploaded to S3 bucket
- Check if ingestion completed (CloudWatch logs)
- Ensure S3 trigger is configured for auto ingestion

#### Deployment Fails

- Check AWS credentials: `aws sts get-caller-identity`
- Verify CDK bootstrap status
- Check IAM permissions

#### Lambda Errors

- Check CloudWatch logs: `/aws/lambda/query-bedrock-llm`
- Verify environment variables in Lambda console
- Check Bedrock model access

#### Auto-Ingestion Not Working

- Check Lambda triggers in console
- Look for `/aws/lambda/start-ingestion-trigger` logs
- Verify S3 event notifications are configured

### Rate Limiting

Current settings:

- 10 requests per second
- 20 burst requests
- 1000 requests per day

Monitor usage in API Gateway console â†’ Usage Plans.

---

## Post-Deployment Steps

1. **Upload Documents**: Add PDF/text files to the created S3 bucket
2. **Wait for Ingestion**: Documents are automatically processed by knowledge base when uploaded
3. **Test Q&A**: Use the frontend to ask questions about your documents
4. **Monitor Usage**: Check CloudWatch logs and API Gateway metrics
5. **Scale as Needed**: Adjust rate limits and model selection based on usage

## Referrence

- [Knowledge Bases now delivers fully managed RAG experience in Amazon Bedrock](https://aws.amazon.com/blogs/aws/knowledge-bases-now-delivers-fully-managed-rag-experience-in-amazon-bedrock/)
- [Building Serverless Resume AI](https://community.aws/content/2bi5tqITxIperTzMsD3ohYbPIA4/easy-rag-with-amazon-bedrock-knowledge-base?lang=en)
